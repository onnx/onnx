trigger:
- master

jobs:
- job: 'Test'
  pool:
    vmImage: 'macOS-10.14'
  strategy:
    matrix:
      py27:
        python.version: '2.7'
        onnx_ml: 0
        onnx_debug: 0
      py36:
        python.version: '3.6'
        onnx_ml: 0
        onnx_debug: 0
      py36-debug:
        python.version: '3.6'
        onnx_ml: 0
        onnx_debug: 1
      py36-onnx-ml:
        python.version: '3.6'
        onnx_ml: 1
        onnx_debug: 0
    maxParallel: 4

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(python.version)'

  - script: |
      git submodule update --init --recursive
      python -m pip install --upgrade setuptools
      python -m pip install numpy
      conda install -c conda-forge pybind11 protobuf
      brew install protobuf
      export ONNX_ML=${onnx_ml}
      export DEBUG=${onnx_debug}
      export ONNX_BUILD_TESTS=1
      export USE_MSVC_STATIC_RUNTIME=0
      export CMAKE_ARGS=-DONNX_WERROR=ON -DONNX_USE_PROTOBUF_SHARED_LIBS=ON -DProtobuf_USE_STATIC_LIBS=OFF -DONNX_USE_LITE_PROTO=ON
      python setup.py --quiet install
    displayName: 'Install dependencies and ONNX'

  - script: |
      pip install --quiet pytest nbval
      pytest

      pip install --quiet flake8
      flake8

      .setuptools-cmake-build/onnx_gtests
      .setuptools-cmake-build/onnxifi_test_driver_gtests onnx/backend/test/data/node

      python onnx/defs/gen_doc.py
      python onnx/gen_proto.py -l
      python onnx/gen_proto.py -l --ml
      python onnx/backend/test/stat_coverage.py
      backend-test-tools generate-data

      git status
      git diff --exit-code

    displayName: 'Run ONNX Tests'
