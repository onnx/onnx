# Copyright (c) ONNX Project Contributors
#
# SPDX-License-Identifier: Apache-2.0

name: Create Releases
on:
  schedule:
    # Run weekly on Monday 00:00 UTC 
    - cron:  '00 00 * * MON'
  push:
    branches: [main, rel-*]
  pull_request:
    branches: [main, rel-*]
    types: 
      - labeled  # Trigger when a label is added to a PR, more information: https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#pull_request
  workflow_dispatch:    

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'workflow_dispatch' }}
  cancel-in-progress: true

jobs:

  set-date:
    # define time for dev build, weekly at the moment
    runs-on: ubuntu-latest
    outputs:
      current_date: ${{ steps.set-date.outputs.current_date }}

    steps:
    - name: Set current date
      id: set-date
      run: |
        # Get the current date in the format YYYY-MM-DD
        CURRENT_DATE=$(date +'%Y%m%d')
        echo "Current date is: $CURRENT_DATE"

        # Set output variable for the job
        echo "::set-output name=current_date::$CURRENT_DATE"

  call-workflow-ubuntu_x86:
    needs: set-date 
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run release CIs')
    uses: ./.github/workflows/release_linux_x86_64.yml
    with:            
      os: "linux_x86_64"
      current_date: ${{ needs.set-date.outputs.current_date }} 
    secrets: inherit

  call-workflow-ubuntu_aarch64:
    needs: set-date
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run release CIs')
    uses: ./.github/workflows/release_linux_aarch64.yml
    with:            
      os: "linux_aarch64"      
      current_date: ${{ needs.set-date.outputs.current_date }}
    secrets: inherit

  call-workflow-win:
    needs: set-date
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run release CIs')
    uses: ./.github/workflows/release_win.yml
    with:      
      os: "win"      
      current_date: ${{ needs.set-date.outputs.current_date }}
    secrets: inherit

  call-workflow-mac:
    needs: set-date
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run release CIs')
    uses: ./.github/workflows/release_mac.yml
    with:            
      os: "macos"      
      current_date: ${{ needs.set-date.outputs.current_date }}
    secrets: inherit

  call-workflow-sdist:
    needs: set-date
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run release CIs')
    uses: ./.github/workflows/release_sdist.yml
    with:            
      os: "macos"      
      current_date: ${{ needs.set-date.outputs.current_date }}
    secrets: inherit

  publish_to_testpypi-onnx-weekly: 
      name: Publish onnx-weekly to testpypi
      runs-on: ubuntu-latest
      needs: [call-workflow-ubuntu_x86, call-workflow-ubuntu_aarch64, call-workflow-mac, call-workflow-win, call-workflow-sdist]
      if: ${{ always() }} && (github.event_name == 'schedule') # https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#example-not-requiring-successful-dependent-jobs
      
      environment:
        name: testpypi 
        url: https://test.pypi.org/p/onnx-weekly
       
      permissions:
        contents: write  # IMPORTANT: mandatory for making GitHub Releases
        id-token: write  # IMPORTANT: mandatory for sigstore     
  
      steps:

        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
          if: (github.event_name == 'schedule') && ((needs.call-workflow-mac.result == 'success') || (needs.call-workflow-ubuntu_x86.result == 'success') || (needs.call-workflow-ubuntu_aarch64.result == 'success') || (needs.call-workflow-win.result == 'success'))
          with:
            pattern: wheels* 
            path: dist
            merge-multiple: true
  
        - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
          if: (github.event_name == 'schedule') && (needs.call-workflow-sdist.result == 'success')
          with:
            pattern: sdist 
            path: dist
            merge-multiple: true
  
        - name: Publish onnx-weekly to PyPI
          if: (github.event_name == 'schedule') && (github.repository_owner == 'onnx')
          uses: pypa/gh-action-pypi-publish@15c56dba361d8335944d31a2ecd17d700fc7bcbc
          with:   
            repository-url: https://test.pypi.org/legacy/
            verbose: true     
            print-hash: true  


  publish_to_pypi-onnx-weekly: 
    name: Publish to pypi-onnx-weekly
    runs-on: ubuntu-latest
    needs: [call-workflow-ubuntu_x86, call-workflow-ubuntu_aarch64, call-workflow-mac, call-workflow-win, call-workflow-sdist]
    if: ${{ always() }} && (github.event_name == 'schedule') # https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#example-not-requiring-successful-dependent-jobs
    
    environment:      
      name: pypi-weekly 
      url: https://pypi.org/p/onnx-weekly

    permissions:
      contents: write  # IMPORTANT: mandatory for making GitHub Releases
      id-token: write  # IMPORTANT: mandatory for sigstore     

    steps:

      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        if: (github.event_name == 'schedule') && ((needs.call-workflow-mac.result == 'success') || (needs.call-workflow-ubuntu_x86.result == 'success') || (needs.call-workflow-ubuntu_aarch64.result == 'success') || (needs.call-workflow-win.result == 'success'))
        with:
          pattern: wheels* 
          path: dist
          merge-multiple: true

      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        if: (github.event_name == 'schedule') && (needs.call-workflow-sdist.result == 'success')
        with:
          pattern: sdist 
          path: dist
          merge-multiple: true

      - name: Publish onnx-weekly to PyPI
        if: (github.event_name == 'schedule') && (github.repository_owner == 'onnx')
        uses: pypa/gh-action-pypi-publish@15c56dba361d8335944d31a2ecd17d700fc7bcbc
        with:   
          repository-url: https://pypi.org/legacy/
          verbose: true     
          print-hash: true  


  test_sdist:    
    needs: [publish_to_pypi-onnx-weekly]    
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run release CIs')
    uses: ./.github/workflows/release_test_weekly_sdist.yml
    with:            
      os: "macos"      
    secrets: inherit
  

