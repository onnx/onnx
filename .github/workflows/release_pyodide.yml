# Copyright (c) ONNX Project Contributors
#
# SPDX-License-Identifier: Apache-2.0

# This workflow builds ONNX wheels for Pyodide (WebAssembly).
# Pyodide wheels allow ONNX to run in web browsers.
#
# Key adaptations from the original josephrocca/onnx-pyodide build process:
# - Uses modern pyodide-build tool (vs. manual emscripten compilation)
# - Automatically detects compatible emscripten version via pyodide config
# - Uses GitHub Actions caching for emscripten and protobuf builds
# - Dynamically determines protobuf version from requirements
# - Builds both WASM protobuf (for linking) and native protobuf (for protoc binary)
# - Uses --exports whole_archive flag to ensure all symbols are included
# - Removes test data from wheel to optimize size (~10MB -> ~1.5MB)

name: PyodideRelease

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      build_mode:
        required: true
        type: string

permissions:
  contents: read

jobs:
  build:
    if: github.event_name != 'pull_request' || startsWith( github.base_ref, 'rel-') || contains( github.event.pull_request.labels.*.name, 'run release CIs')

    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: true
        submodules: true

    - name: Set up Python 3.12
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: '3.12'

    - name: Install pyodide-build and dependencies
      run: |
        python -m pip install -q --upgrade pip
        python -m pip install pyodide-build
        python -m pip install "pybind11[global]"

    - name: Get Pyodide emscripten version
      id: pyodide_version
      run: |
        PYODIDE_EMSCRIPTEN_VERSION=$(pyodide config get emscripten_version)
        echo "emscripten_version=${PYODIDE_EMSCRIPTEN_VERSION}" >> $GITHUB_OUTPUT
        echo "Using emscripten version: ${PYODIDE_EMSCRIPTEN_VERSION}"

    - name: Cache emsdk
      id: cache-emsdk
      uses: actions/cache@v4
      with:
        path: emsdk
        key: emsdk-${{ steps.pyodide_version.outputs.emscripten_version }}

    - name: Install and activate emscripten
      if: steps.cache-emsdk.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/emscripten-core/emsdk
        cd emsdk
        ./emsdk install ${{ steps.pyodide_version.outputs.emscripten_version }}
        ./emsdk activate ${{ steps.pyodide_version.outputs.emscripten_version }}

    - name: Activate emscripten environment
      run: |
        cd emsdk
        source emsdk_env.sh
        # Make emscripten available to subsequent steps
        echo "EMSDK=$(pwd)" >> $GITHUB_ENV
        echo "$(pwd)" >> $GITHUB_PATH
        echo "$(pwd)/upstream/emscripten" >> $GITHUB_PATH

    - name: Determine protobuf version
      id: protobuf_version
      run: |
        # Get protobuf version from requirements
        # Fallback to 5.29.2 if not found (current stable protobuf version)
        PROTOBUF_VERSION=$(python -c "import re; content=open('requirements-release_build.txt').read(); match=re.search(r'protobuf>=([0-9.]+)', content); print(match.group(1) if match else '5.29.2')")
        echo "version=${PROTOBUF_VERSION}" >> $GITHUB_OUTPUT
        echo "Using protobuf version: ${PROTOBUF_VERSION}"

    - name: Cache protobuf-wasm
      id: cache-protobuf-wasm
      uses: actions/cache@v4
      with:
        path: protobuf-wasm
        key: protobuf-wasm-${{ steps.pyodide_version.outputs.emscripten_version }}-${{ steps.protobuf_version.outputs.version }}

    - name: Build protobuf for WASM
      if: steps.cache-protobuf-wasm.outputs.cache-hit != 'true'
      run: |
        source emsdk/emsdk_env.sh

        # Clone and checkout the right version
        git clone https://github.com/protocolbuffers/protobuf.git protobuf-wasm
        cd protobuf-wasm
        git checkout v${{ steps.protobuf_version.outputs.version }}
        git submodule update --init --recursive

        # Build with emscripten
        mkdir -p build_source
        cd build_source
        emcmake cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -Dprotobuf_BUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_SYSCONFDIR=/etc \
          -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
          -Dprotobuf_BUILD_TESTS=OFF \
          -Dprotobuf_BUILD_PROTOC_BINARIES=OFF \
          -Dprotobuf_ABSL_PROVIDER=module

        emmake make -j$(nproc)
        cd ../..

    - name: Cache protobuf-native
      id: cache-protobuf-native
      uses: actions/cache@v4
      with:
        path: protobuf-native
        key: protobuf-native-${{ steps.protobuf_version.outputs.version }}

    - name: Build native protobuf for protoc
      if: steps.cache-protobuf-native.outputs.cache-hit != 'true'
      run: |
        # Clone and checkout the right version
        git clone https://github.com/protocolbuffers/protobuf.git protobuf-native
        cd protobuf-native
        git checkout v${{ steps.protobuf_version.outputs.version }}
        git submodule update --init --recursive

        # Build natively (not with emscripten) to get protoc binary
        # CMake configuration is similar to WASM build but without emcmake
        mkdir -p build_source
        cd build_source
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -Dprotobuf_BUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_SYSCONFDIR=/etc \
          -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
          -Dprotobuf_BUILD_TESTS=OFF \
          -Dprotobuf_ABSL_PROVIDER=module

        make -j$(nproc)
        cd ../..

    - name: Install protoc to system
      run: |
        cd protobuf-native/build_source
        sudo make install
        sudo ldconfig
        which protoc
        protoc --version

    - name: Configure build environment
      run: |
        source emsdk/emsdk_env.sh

        # Set up build mode
        if [ '${{ inputs.build_mode }}' != 'release' ]; then
          echo "Building preview wheels..."
          sed -i 's/name = "onnx"/name = "onnx-weekly"/' 'pyproject.toml'
          export ONNX_PREVIEW_BUILD=1
          echo "ONNX_PREVIEW_BUILD=1" >> $GITHUB_ENV
        else
          echo "Building release wheels..."
        fi

        # Configure ONNX build settings
        export ONNX_ML=1
        echo "ONNX_ML=1" >> $GITHUB_ENV

        # Set CMAKE_ARGS for pyodide build
        export CMAKE_ARGS="-DONNX_USE_PROTOBUF_SHARED_LIBS=OFF \
          -DONNX_USE_LITE_PROTO=ON \
          -DProtobuf_INCLUDE_DIR=$(pwd)/protobuf-wasm/src \
          -DProtobuf_LIBRARIES=$(pwd)/protobuf-wasm/build_source/libprotobuf.a \
          -DProtobuf_LITE_LIBRARY=$(pwd)/protobuf-wasm/build_source/libprotobuf-lite.a \
          -Dpybind11_DIR=$(python -c 'import pybind11 as _; print(_.__path__[0])')/share/cmake/pybind11 \
          -DPYTHON_INCLUDE_DIR=$(python -c 'import sysconfig; print(sysconfig.get_path(\"include\"))') \
          -DPYTHON_LIBRARY=$(python -c 'import sysconfig; print(sysconfig.get_config_var(\"LIBDIR\"))') \
          -DCMAKE_C_FLAGS=\"-fPIC\" \
          -DCMAKE_CXX_FLAGS=\"-fPIC\""

        echo "CMAKE_ARGS=${CMAKE_ARGS}" >> $GITHUB_ENV

    - name: Build Pyodide wheel
      run: |
        source emsdk/emsdk_env.sh

        # Build with pyodide-build using whole_archive to ensure all symbols are included
        pyodide build --exports whole_archive

    - name: Optimize wheel size
      run: |
        # Remove test data to reduce wheel size (brings it from ~10MB to ~1.5MB)
        # This is safe because test data is not needed at runtime
        wheel_file=$(ls dist/*.whl)
        if [ -f "$wheel_file" ]; then
          echo "Optimizing wheel: $wheel_file"
          original_size=$(stat -c%s "$wheel_file")
          echo "Original size: $original_size bytes ($(numfmt --to=iec-i --suffix=B $original_size))"

          # Remove test data from the wheel (ignore errors if pattern doesn't exist)
          if zip --delete "$wheel_file" 'onnx/backend/test/data/*' 2>/dev/null; then
            echo "Successfully removed test data from wheel"
          else
            echo "Note: No test data found in wheel or already removed"
          fi

          optimized_size=$(stat -c%s "$wheel_file")
          echo "Optimized size: $optimized_size bytes ($(numfmt --to=iec-i --suffix=B $optimized_size))"
          echo "Size reduction: $((original_size - optimized_size)) bytes"
          ls -lh dist/
        else
          echo "Error: Wheel file not found"
          exit 1
        fi

    - name: Upload Pyodide wheel
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: wheels-${{ inputs.os }}-pyodide
        path: dist/*.whl

  test:
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Download wheel
        uses: actions/download-artifact@v7.0.0
        with:
          name: wheels-${{ inputs.os }}-pyodide
          path: ./dist

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test wheel with Pyodide
        run: |
          python -m pip install pyodide-build

          # Create a simple test script
          cat > test_pyodide.py << 'EOF'
          import asyncio
          from pyodide_build.testing import run_in_pyodide

          @run_in_pyodide
          def test_onnx_import():
              import onnx
              print(f"ONNX version: {onnx.__version__}")
              # Test basic functionality
              assert hasattr(onnx, 'ModelProto')
              assert hasattr(onnx, 'TensorProto')
              return True

          async def main():
              result = await test_onnx_import()
              print(f"Test result: {result}")
              assert result, "Test failed"

          if __name__ == "__main__":
              asyncio.run(main())
          EOF

          # Install the wheel in Pyodide environment and run test
          wheel_file=$(ls dist/*.whl)
          echo "Testing wheel: $wheel_file"

          # For now, just verify the wheel file exists and is reasonable size
          if [ -f "$wheel_file" ]; then
            echo "Wheel file found: $wheel_file"
            ls -lh "$wheel_file"

            # Check wheel size is reasonable (should be 1-5 MB after optimization)
            size=$(stat -c%s "$wheel_file")
            echo "Wheel size: $size bytes"

            # Verify it's a valid zip file
            unzip -t "$wheel_file" > /dev/null
            echo "Wheel file is valid"
          else
            echo "Error: Wheel file not found"
            exit 1
          fi
